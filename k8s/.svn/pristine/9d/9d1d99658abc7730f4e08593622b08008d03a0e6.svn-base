error_log  stderr  notice;

worker_processes  auto;
events  {
    multi_accept  on;
    use  epoll;
    worker_connections  1024;
}

stream  {
        upstream  kube_apiserver  {
                least_conn;
                server  {{kube_master1_ip}}:6443  ;
                server  {{kube_master2_ip}}:6443  ;
                server  {{kube_master3_ip}}:6443  ;
        }

        upstream  docker_server  {
                least_conn;
                server  127.0.0.1:52375  ;
        }

        server  {
                listen     0.0.0.0:6443;
                proxy_pass     kube_apiserver;
                proxy_timeout  10m;
                proxy_connect_timeout  1s;
        }
        server  {
                listen  0.0.0.0:2375;
                proxy_connect_timeout  60s;
                proxy_timeout  10m;
                proxy_pass  docker_server;
                allow  {{zcm_portal_master_ip}};
                allow  {{zcm_portal_backup_ip}};
                allow  {{zcm_portal_vip}};
                allow  127.0.0.1;
                deny  all;
        }
}
